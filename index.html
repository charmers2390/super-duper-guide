<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LunaBotAI</title>
  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#0a0a0a; color:#eee; display:flex; flex-direction:column; height:100vh; transition: background 0.3s, color 0.3s; }
    header { background:#111; padding:14px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; color:#eee; }
    header span { cursor:pointer; font-size:18px; }
    #sidebar { position:fixed; left:-280px; top:0; width:260px; height:100%; background:#141414; transition:left .3s; display:flex; flex-direction:column; }
    #sidebar.open { left:0; }
    #chatList { flex:1; overflow-y:auto; padding:10px; }
    .chat-item { background:#222; margin:5px 0; padding:8px; border-radius:6px; cursor:pointer; }
    .chat-item:hover { background:#333; }
    .chat-item[contenteditable="true"] { outline: 2px solid #10a37f; }
    #searchBar { padding:8px; margin:10px; border-radius:8px; border:none; background:#222; color:#eee; }
    #settingsHeader { border-top:1px solid #333; padding:12px; cursor:pointer; background:#111; }
    #settingsHeader:hover { background:#222; }
    #settings { padding:10px; border-top:1px solid #333; display:none; }
    #chat { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; }
    .msg { max-width:75%; padding:10px; margin:6px 0; border-radius:10px; line-height:1.4; }
    .user { background:#10a37f; align-self:flex-end; }
    .bot { background:#333; align-self:flex-start; }
    .error { background:#a00; color:#fff; align-self:center; }
    .file { background:#444; border:1px solid #666; font-style:italic; }
    #inputBar { display:flex; padding:10px; border-top:1px solid #333; gap:6px; }
    #inputBar input[type="text"] { flex:1; padding:10px; border-radius:20px; border:none; background:#222; color:#fff; }
    #inputBar button, #inputBar label { border:none; border-radius:20px; padding:10px; background:#10a37f; color:#fff; cursor:pointer; white-space:nowrap; }
    #stopBtn { display:none; background:#a00; }
    /* Light mode */
    body.light { background:#f9f9f9; color:#111; }
    body.light header { background:#e1e1e1; color:#111; border-bottom:1px solid #bbb; }
    body.light #sidebar { background:#f0f0f0; }
    body.light .chat-item { background:#ddd; color:#111; }
    body.light .chat-item:hover { background:#ccc; }
    body.light .user { background:#007bff; color:#fff; }
    body.light .bot { background:#ddd; color:#111; }
    body.light #inputBar input[type="text"] { background:#e1e1e1; color:#111; }
    body.light #inputBar button, body.light #inputBar label { background:#007bff; color:#fff; }
  </style>
</head>
<body>
  <header>
    <span onclick="toggleSidebar()">‚ò∞</span> LunaBotAI
  </header>
  
  <div id="sidebar">
    <input id="searchBar" type="text" placeholder="Search chats..." oninput="filterChats()" />
    <div id="chatList"></div>
    <div id="settingsHeader" onclick="toggleSettings()">‚öô Settings</div>
    <div id="settings">
      <label>Language:
        <select id="lang" onchange="updateSettings()">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="fr">Fran√ßais</option>
        </select>
      </label><br><br>
      <label>Model:
        <select id="model" onchange="updateSettings()">
          <option value="gpt-5">ChatGPT-5</option>
          <option value="gpt-4o">ChatGPT-4o</option>
        </select>
      </label><br><br>
      <label>Theme:
        <select id="theme" onchange="updateTheme()">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </label><br><br>
      <button onclick="exportChat('txt')">‚¨á Export TXT</button>
      <button onclick="exportChat('json')">‚¨á Export JSON</button><br><br>
      <button onclick="clearChats()">üóë Clear All Chats</button>
    </div>
  </div>
  
  <div id="chat"></div>
  
  <div id="inputBar">
    <input id="userInput" type="text" placeholder="Ask anything..." />
    <label for="fileInput">üìé Upload</label>
    <input id="fileInput" type="file" style="display:none;" onchange="handleFile(event)" />
    <button onclick="sendMessage()">‚û§</button>
    <button id="stopBtn" onclick="stopGenerating()">‚èπ Stop</button>
  </div>
  
<script>
  const chat = document.getElementById('chat');
  const chatList = document.getElementById('chatList');
  const userInput = document.getElementById('userInput');
  const stopBtn = document.getElementById('stopBtn');
  let chats = JSON.parse(localStorage.getItem('lunabot_chats')||'[]');
  let currentChat = null;
  let settings = JSON.parse(localStorage.getItem('lunabot_settings')||'{"lang":"en","model":"gpt-5","theme":"dark"}');
  let abortController = null;

  function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); renderChats(); }
  function toggleSettings(){ const s=document.getElementById('settings'); s.style.display=(s.style.display==="none"||!s.style.display)?"block":"none"; }
  function newChat(){ currentChat={id:Date.now(),title:"New Chat",messages:[]}; chats.unshift(currentChat); saveChats(); renderChats(); chat.innerHTML=""; }
  function renderChats(filter=""){ chatList.innerHTML=""; chats.filter(c=>c.title.toLowerCase().includes(filter.toLowerCase())).forEach(c=>{ let div=document.createElement('div'); div.className="chat-item"; div.textContent=c.title; div.ondblclick=()=>editTitle(div,c); div.onclick=()=>loadChat(c.id); chatList.appendChild(div); }); }
  function editTitle(div,c){ div.contentEditable=true; div.focus(); div.onblur=()=>{ c.title=div.textContent; saveChats(); div.contentEditable=false; }; div.onkeypress=(e)=>{ if(e.key==="Enter"){e.preventDefault();div.blur();}}}
  function loadChat(id){ currentChat=chats.find(c=>c.id===id); chat.innerHTML=""; currentChat.messages.forEach(m=>appendMessage(m.text,m.cls)); toggleSidebar(); }
  function saveChats(){ localStorage.setItem('lunabot_chats',JSON.stringify(chats)); }
  function clearChats(){ chats=[]; saveChats(); renderChats(); chat.innerHTML=""; }
  function updateSettings(){ settings={...settings, lang:document.getElementById('lang').value, model:document.getElementById('model').value}; localStorage.setItem('lunabot_settings',JSON.stringify(settings)); }
  function updateTheme(){ settings.theme=document.getElementById('theme').value; localStorage.setItem('lunabot_settings',JSON.stringify(settings)); applyTheme(); }
  function applyTheme(){ document.body.className=settings.theme==="light"?"light":""; }
  function filterChats(){ const q=document.getElementById('searchBar').value; renderChats(q); }
  function exportChat(format){ if(!currentChat)return alert("No chat open"); let content=""; let filename="chat."+format; if(format==="txt"){ content=currentChat.messages.map(m=>m.cls.toUpperCase()+": "+m.text).join("\n"); } else { content=JSON.stringify(currentChat,null,2); } let blob=new Blob([content],{type:"text/plain"}); let url=URL.createObjectURL(blob); let a=document.createElement("a"); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

  function appendMessage(text,cls){ let div=document.createElement('div'); div.className='msg '+cls; div.textContent=text; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; return div; }

  async function sendMessage(msgOverride){
    const text=msgOverride||userInput.value.trim(); if(!text)return;
    if(!currentChat)newChat();
    appendMessage(text,'user'); currentChat.messages.push({text,cls:'user'}); if(currentChat.title==="New Chat")currentChat.title=text.slice(0,30);
    saveChats(); userInput.value="";
    let botMsg=appendMessage("","bot"); currentChat.messages.push({text:"",cls:'bot'}); saveChats();

    stopBtn.style.display="inline-block"; abortController=new AbortController();
    try{
      const response=await fetch("https://openaiandlunabotai.onrender.com/api/chat",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:text,lang:settings.lang,model:settings.model,history:currentChat.messages.map(m=>({role:m.cls==="user"?"user":"assistant",content:m.text}))}),
        signal:abortController.signal
      });
      if(!response.body){ botMsg.textContent="(No response stream)"; return; }
      const reader=response.body.getReader(); const decoder=new TextDecoder();
      let done=false;
      while(!done){
        const {value,done:streamDone}=await reader.read();
        if(value){
          let chunk=decoder.decode(value);
          botMsg.textContent+=chunk;
          currentChat.messages[currentChat.messages.length-1].text=botMsg.textContent;
          saveChats();
          chat.scrollTop=chat.scrollHeight;
        }
        done=streamDone;
      }
    }catch(err){ if(err.name!=="AbortError") botMsg.textContent="Error: "+err.message; }
    finally{ stopBtn.style.display="none"; abortController=null; }
  }

  function stopGenerating(){ if(abortController){ abortController.abort(); stopBtn.style.display="none"; } }

  function handleFile(event){
    const file=event.target.files[0]; if(!file)return;
    if(file.size>20*1024*1024){ appendMessage("‚ùå File too large. Max size is 20 MB.","error"); return; }
    const ext=file.name.split('.').pop().toLowerCase();
    if(ext==="png"||ext==="jpg"||ext==="jpeg"||ext==="gif"||ext==="zip"){ appendMessage("‚ùå File type not allowed.","error"); return; }
    const reader=new FileReader();
    reader.onload=function(e){
      const text=e.target.result;
      if(/base64/i.test(text)){ appendMessage("‚ùå Base64 content not allowed.","error"); return; }
      appendMessage("üìÑ Uploaded file: "+file.name+" ("+Math.round(file.size/1024)+" KB)","file");
      sendMessage(text);
    };
    reader.readAsText(file);
  }

  // Init
  document.getElementById('lang').value=settings.lang;
  document.getElementById('model').value=settings.model;
  document.getElementById('theme').value=settings.theme;
  applyTheme();
  renderChats();
</script>
</body>
</html>
